name: ci

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect private registry configuration
        id: registry
        run: |
          is_private=false
          if [ -f ".npmrc" ]; then
            if grep -Eq "_authToken|always-auth" .npmrc; then
              is_private=true
            elif grep -Eq "@[^:[:space:]]+:registry" .npmrc; then
              # Scoped registry overrides require auth when not pointing at the public registry
              if grep -E "@[^:[:space:]]+:registry" .npmrc | grep -vq "https://registry.npmjs.org/?"; then
                is_private=true
              fi
            elif grep -Eq "registry\s*=\s*" .npmrc; then
              if grep -E "registry\s*=\s*" .npmrc | grep -vq "https://registry.npmjs.org/?"; then
                is_private=true
              fi
            fi
          fi

          if [ "$is_private" = "true" ]; then
            echo "private=true" >>"$GITHUB_OUTPUT"
          else
            echo "private=false" >>"$GITHUB_OUTPUT"
          fi

      - uses: actions/setup-node@v4
        if: steps.registry.outputs.private == 'false'
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        if: steps.registry.outputs.private == 'false'
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            echo "package-lock.json missing; falling back to npm install" >&2
            npm install
          fi

      - run: npm run lint --if-present
        if: steps.registry.outputs.private == 'false'
      - run: npm test --if-present
        if: steps.registry.outputs.private == 'false'
      - run: npm run build --if-present
        if: steps.registry.outputs.private == 'false'

      - name: Skip until npm auth configured
        if: steps.registry.outputs.private == 'true'
        run: |
          echo "Skipping build: private registry detected in .npmrc. Configure NODE_AUTH_TOKEN (or an appropriate secret) before re-running."
